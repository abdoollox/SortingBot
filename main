import random # Kod boshiga qo'shing

# --- YANGI SOZLAMALAR (SORTING HAT UCHUN) ---
# Bu yerga o'z rasm ID laringizni qo'ying:
HAT_IMG_ID = "AgACAgIAAxkBA..." # Shlyapa rasmi
GRYFFINDOR_ID = "AgACAgIAAxkBA..." 
SLYTHERIN_ID = "AgACAgIAAxkBA..."
RAVENCLAW_ID = "AgACAgIAAxkBA..."
HUFFLEPUFF_ID = "AgACAgIAAxkBA..."

# "Sorting Hat" topigi ID si (Guruhdagi Topic IDsi)
# Buni bilish uchun guruhdagi o'sha topikga biror narsa yozib, 
# bot orqali message.message_thread_id ni print qilib ko'rish kerak.
# Hozircha 0 yoki None qilib turing, keyin to'g'irlaymiz.
SORTING_TOPIC_ID = None 

# Fakultetlar va ularning ma'lumotlari
HOUSES = {
    "Gryffindor": {"id": GRYFFINDOR_ID, "desc": "ü¶Å **Gryffindor!**\nSiz jasur va mardsiz!", "emoji": "ü¶Å"},
    "Slytherin": {"id": SLYTHERIN_ID, "desc": "üêç **Slytherin!**\nSiz ayor va maqsadgasiroqsiz!", "emoji": "üêç"},
    "Ravenclaw": {"id": RAVENCLAW_ID, "desc": "ü¶Ö **Ravenclaw!**\nSiz aqlli va donosiz!", "emoji": "ü¶Ö"},
    "Hufflepuff": {"id": HUFFLEPUFF_ID, "desc": "ü¶° **Hufflepuff!**\nSiz mehnatkash va sodiqsiz!", "emoji": "ü¶°"}
}

# Foydalanuvchilar qaysi uyda ekanligini saqlash uchun
# (Haqiqiy loyihada bu bazada turishi kerak, hozircha xotirada)
USER_HOUSES = {} 

# --- YANGI MEMBER QO'SHILGANDA (SORTING HAT TAKLIFI) ---
@dp.message(F.new_chat_members)
async def welcome_new_member(message: types.Message):
    for user in message.new_chat_members:
        # Botning o'zi kirganda javob bermasin
        if user.id == bot.id:
            continue
            
        caption_text = (
            f"üßô‚Äç‚ôÇÔ∏è **Xush kelibsiz, {user.first_name}!**\n\n"
            "Siz Hogwarts ostonasidasiz. Lekin darslarni boshlashdan oldin,"
            "siz qaysi Fakultetga tegishli ekaningizni aniqlashimiz kerak.\n\n"
            "üëá **Qalpoqni kiyish uchun tugmani bosing:**"
        )
        
        tugma = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üé© Qalpoqni kiyish", callback_data=f"wear_hat_{user.id}")]
        ])
        
        # Agar Topic ID aniq bo'lsa o'sha yerga, bo'lmasa umumiy chatga yozadi
        try:
            await bot.send_photo(
                chat_id=message.chat.id,
                message_thread_id=SORTING_TOPIC_ID, 
                photo=HAT_IMG_ID,
                caption=caption_text,
                reply_markup=tugma,
                parse_mode="Markdown"
            )
        except:
            await message.answer(caption_text, reply_markup=tugma)

# --- QALPOQNI KIYISH LOGIKASI ---
@dp.callback_query(F.data.startswith("wear_hat_"))
async def sorting_hat_process(callback: types.CallbackQuery):
    target_user_id = int(callback.data.split("_")[2])
    clicker_id = callback.from_user.id
    
    # Birovning qalpoqchasini boshqa birov kiya olmaydi!
    if clicker_id != target_user_id:
        await callback.answer("Bu qalpoq siz uchun emas! O'z navbatingizni kuting.", show_alert=True)
        return

    # Agar allaqachon tanlangan bo'lsa
    if clicker_id in USER_HOUSES:
        house_name = USER_HOUSES[clicker_id]
        await callback.answer(f"Siz allaqachon {house_name} talabasisiz!", show_alert=True)
        return

    # 1. Random tanlash jarayoni
    # Biroz "o'ylash" effekti
    await callback.answer("Hmm... Qiyin masala... Juda qiyin...")
    await asyncio.sleep(1) # 1 soniya kutish (realistik bo'lishi uchun)
    
    # Tasodifiy uy tanlash
    house_name = random.choice(list(HOUSES.keys()))
    house_data = HOUSES[house_name]
    
    # Bazaga yozish
    USER_HOUSES[clicker_id] = house_name
    
    # 2. Natijani e'lon qilish
    result_text = (
        f"üéâ **TABRIKLAYMIZ!**\n\n"
        f"Shlyapa qaror qildi: **{callback.from_user.first_name}** endi...\n\n"
        f"{house_data['desc']}\n\n"
        f"Barcha darslarga shu fakultet nomidan qatnashasiz!"
    )
    
    stats_tugma = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìä Fakultetlar ro'yxatini ko'rish", callback_data="show_house_stats")]
    ])
    
    # Eski xabarni o'chirib, yangi rasm (Gerb) bilan chiqaramiz
    await callback.message.delete()
    await callback.message.answer_photo(
        photo=house_data['id'],
        caption=result_text,
        reply_markup=stats_tugma,
        parse_mode="Markdown"
    )

# --- STATISTIKA (RO'YXAT) ---
@dp.callback_query(F.data == "show_house_stats")
async def show_stats(callback: types.CallbackQuery):
    # Hisoblash
    counts = {"Gryffindor": 0, "Slytherin": 0, "Ravenclaw": 0, "Hufflepuff": 0}
    for house in USER_HOUSES.values():
        if house in counts:
            counts[house] += 1
            
    text = (
        "üìä **Hogwarts O'quvchilari Ro'yxati:**\n\n"
        f"ü¶Å Gryffindor: **{counts['Gryffindor']}** ta talaba\n"
        f"üêç Slytherin: **{counts['Slytherin']}** ta talaba\n"
        f"ü¶Ö Ravenclaw: **{counts['Ravenclaw']}** ta talaba\n"
        f"ü¶° Hufflepuff: **{counts['Hufflepuff']}** ta talaba\n\n"
        f"Jami sehrgarlar: **{len(USER_HOUSES)}**"
    )
    
    await callback.answer()
    await callback.message.answer(text, parse_mode="Markdown")
